<?php $themeHelper = $this->helper('MGS\StoreLocator\Helper\Data'); ?>
<?php if ($themeHelper->getStoreConfig('locator/general/store_api_key')) {
    $apikey = $themeHelper->getStoreConfig('locator/general/store_api_key');
} else {
    $apikey = 'AIzaSyD11c9ZFjYyFvKmbp2eKkpRuiqkjkAUIG0';
}
?>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=<?php echo $apikey ?>&libraries=places" async defer></script>
<?php
$markers = array();
// $countries = $this->getCountries();
$agruments = [];
if ($curPage = $this->getRequest()->getParam('p', false)) {
    $agruments['p'] = $curPage;
}
// $country = $this->getRequest()->getParam('country', '');
$state = $this->getRequest()->getParam('state', '');
// $city = $this->getRequest()->getParam('city', '');
// $zipcode = $this->getRequest()->getParam('zipcode', '');

?>
<?php echo $block->getLayout()->getMessagesBlock()->getGroupedHtml() ?>
<div class="view-builders">
    <div class="canvas">
        <div class="page">
            <div class="container">
                <div class="row">
                    <div class="col-sm-12">
                        <?php
                        $mystate = strtolower($state);
                        switch ($mystate) {
                            case 'illinois':
                                $stateHead = 'find-a-builder-illinois-header';
                                break;
                            case 'indiana':
                                $stateHead = 'find-a-builder-indiana-header';
                                break;
                            case 'iowa':
                                $stateHead = 'find-a-builder-iowa-header';
                                break;
                            case 'michigan':
                                $stateHead = 'find-a-builder-michigan-header';
                                break;
                            case 'minnesota':
                                $stateHead = 'find-a-builder-minnesota-header';
                                break;
                            case 'missouri':
                                $stateHead = 'find-a-builder-missouri-header';
                                break;
                            case 'wisconsin':
                                $stateHead = 'find-a-builder-wisconsin-header';
                                break;
                            case 'south-dakota':
                                $stateHead = 'find-a-builder-s-dakota-header';
                                break;
                            case 'kentucky':
                                $stateHead = 'find-a-builder-kentucky-header';
                                break;
                            case 'kansas':
                                $stateHead = 'find-a-builder-kansas-header';
                                break;
                            default:
                                $stateHead = 'find-a-builder-header';
                                break;
                        }
                        echo $this->getLayout()
                            ->createBlock('Magento\Cms\Block\Block')
                            ->setBlockId($stateHead)
                            ->toHtml(); ?>
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-sm-12">
                        <form action="<?php echo $block->getUrl('locator/index/searchbydistance', $agruments) ?>" method="GET">
                            <div class="map-canvas">
                                <?= /* @noEscape */ $block->getBlockHtml('formkey'); ?>
                                <div class="map-controls">
                                    <div class="filter">
                                        <div class="dropdown">
                                            <button class="btn btn-default btn-input dropdown-toggle" type="button" data-toggle="dropdown">Select a State <i class="fa fa-caret-down"></i></button>
                                            <ul name="state" id="state" class="dropdown-menu">
                                                <li><a href="<?php echo $block->getUrl('find-a-builder'); ?>">All Builders</a></li>
                                                <li role="separator" class="divider"></li>
                                                <li><a href="<?php echo $block->getUrl('find-a-builder/index/builderstate/state/illinois'); ?>">Illinois</a></li>
                                                <li><a href="<?php echo $block->getUrl('find-a-builder/index/builderstate/state/indiana'); ?>">Indiana</a></li>
                                                <li><a href="<?php echo $block->getUrl('find-a-builder/index/builderstate/state/iowa'); ?>">Iowa</a></li>
                                                <li><a href="<?php echo $block->getUrl('find-a-builder/index/builderstate/state/kansas'); ?>">Kansas</a></li>
                                                <!-- <li><a href="<?php echo $block->getUrl('find-a-builder/index/builderstate/state/kentucky'); ?>">Kentucky</a></li> -->
                                                <li><a href="<?php echo $block->getUrl('find-a-builder/index/builderstate/state/michigan'); ?>">Michigan</a></li>
                                                <li><a href="<?php echo $block->getUrl('find-a-builder/index/builderstate/state/minnesota'); ?>">Minnesota</a></li>
                                                <li><a href="<?php echo $block->getUrl('find-a-builder/index/builderstate/state/missouri'); ?>">Missouri</a></li>
                                                <li><a href="<?php echo $block->getUrl('find-a-builder/index/builderstate/state/south-dakota'); ?>">South Dakota</a></li>
                                                <li><a href="<?php echo $block->getUrl('find-a-builder/index/builderstate/state/wisconsin'); ?>">Wisconsin</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="search">
                                        <div class="input-group custom-height-input">
                                            <input type="text" name="location" id="location" class="form-control js-search" placeholder="Search by zip...">
                                            <div class="input-group-btn">
                                                <button type="submit" class="btn btn-default js-zipcode"><i class="fa fa-search"></i></button>
                                                <button type="button" onclick="drawMap(markers, googleMapDivId);" class="btn btn-default js-clearzip"><i class="fa fa-refresh"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <?php
                                $_StoreCollection = $this->getStoreCollection();
                                $totalStoreCount = count($_StoreCollection);
                                if (!$totalStoreCount) : ?>
                                    <div class="alert alert-warning"><?php echo __('There are no builders available for this location.') ?></div>
                                <?php else : ?>
                                    <?php $i = 0;
                                    foreach ($_StoreCollection as $store) : $i++; ?>
                                        <?php $markers[$i]['name'] = '<div class="map-short-info"><h6><a class="title-link visitclick-inherit" href="' . $block->getUrl('locator/index/view', ['id' => $store->getId()]) . '">' . $store->getName() . '<br><small><b>' . $store->getSubtitle() . '</b></small></a></h6>'; ?>
                                        <?php $markers[$i]['lat'] = $store->getLat(); ?>
                                        <?php $markers[$i]['long'] = $store->getLng(); ?>
                                        <?php $markers[$i]['name'] .= $store->getStreetAddress() . '<br>'; ?>
                                        <?php $markers[$i]['name'] .= ' ' . $store->getCity(); ?>
                                        <?php $markers[$i]['name'] .= ' ' . $store->getState(); ?>
                                        <?php $markers[$i]['name'] .= ' ' . $store->getZipcode(); ?>
                                        <?php $markers[$i]['name'] .= ' ' . $store->getCountry(); ?>
                                        <?php $markers[$i]['name'] .= '</p>'; ?>
                                        <?php if ($store->getPhoneNumber()) : ?>
                                            <?php $markers[$i]['name'] .= '<p>' . __('Phone: ') . '<a href="tel:' . $store->getPhoneNumber() . '">' . $store->getPhoneNumber() . '</a></p>'; ?>
                                        <?php endif; ?>
                                        <?php //$markers[$i]['name'] .= '<p><a href="' . $block->getUrl('locator/index/view', ['id' => $store->getId()]) . '">' . __('Details') . '</a></p>'; 
                                        ?>
                                        <?php
                                        $markers[$i]['name'] .= '<p> <a class="btn btn-sm btn-block-xs btn-primary visitclick-white" href="' . $block->getUrl('locator/index/view', ['id' => $store->getId()]) . '">Learn More <i class="fa fa-angle-double-right"></i></a> <a class="btn btn-sm btn-block-xs btn-primary-o visitclick-blue" href="' . $block->getUrl('locator/index/view', ['id' => $store->getId()]) . '#contact' . '">Contact <i class="fa fa-angle-double-right"></i></a> </p>';
                                        ?>
                                        <?php $markers[$i]['name'] .= '</div>'; ?>
                                    <?php endforeach ?>
                                <?php endif ?>
                                <?php echo $this->getPager()
                                ?>
                                <?php if ($totalStoreCount) : ?>
                                    <div id="map" class="map js-map"></div>
                                    <?php if (is_array($markers) && count($markers) > 0) : ?>
                                        <script>
                                            //<![CDATA[
                                            var markers = [
                                                <?php foreach ($markers as $marker) : ?>['<?php echo str_replace("'", "\'", $marker['name']); ?>', <?php echo $marker['lat']; ?>, <?php echo $marker['long']; ?>],
                                                <?php endforeach ?>
                                                <?php if ($this->getRequest()->getParam('lat_search') && $this->getRequest()->getParam('long_search')) : ?>
                                                    //['<?php echo __('Your Location'); ?>',<?php echo $this->getRequest()->getParam('lat_search'); ?>,<?php echo $this->getRequest()->getParam('long_search'); ?>],
                                                <?php endif ?>
                                            ];
                                            //]]>
                                        </script>
                                    <?php endif ?>
                                <?php endif ?>
                                <div class="builder-list">
                                    <?php
                                    $storeList = $block->getStateStore($state);
                                    $storeCount = count($storeList);
                                    if ($storeCount > 0) {
                                    ?>
                                        <div class="col-sm-12 section-sm">
                                            <h2 class="text-uppercase">Browse home builders in <?php echo $state; ?></h2>
                                        </div>
                                        <div class="row row-sm-flex">
                                            <?php foreach ($storeList as $stList) { ?>
                                                <div class="builder">
                                                    <div class="builder-details">
                                                        <div class="panel-body">
                                                            <h4 class="text-uppercase"><a class="title-link visitclick-inherit" href="<?php echo $block->getUrl('locator/index/view', ['id' => $stList->getId()]); ?>"><?php echo $stList->getName(); ?> <br><small><b><?php echo $stList->getSubtitle(); ?></b></small></a></h4>
                                                            <p><?php echo $stList->getStreetAddress(); ?>
                                                                <br><?php echo ($stList->getCity() . "," . $stList->getState() . " " . $stList->getZipcode()); ?>
                                                                <br><?php echo $stList->getPhoneNumber(); ?></p>
                                                            <p> <a class="btn btn-sm btn-block-xs btn-primary visitclick-white" href="<?php echo $block->getUrl('locator/index/view', ['id' => $stList->getId()]); ?>">Learn More <i class="fa fa-angle-double-right"></i></a> <a class="btn btn-sm btn-block-xs btn-primary-o visitclick-blue" href="<?php echo $block->getUrl('locator/index/view', ['id' => $stList->getId()]) . '#contact'; ?>">Contact <i class="fa fa-angle-double-right"></i></a> </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            <?php } ?>
                                        </div>
                                    <?php } ?>
                                </div>
                            </div>
                        </form>
                        <div class="well well-lg text-center">
                            <h4 class="text-uppercase">Not sure which home builder services your area?</h4>
                            <p>Contact us and weâ€™ll get back to you as soon as we can.</p>
                            <p><a class="btn btn-text link-custom-color" href="<?php echo $block->getUrl('contact') ?>">Contact Our Main Office <i class="fa fa-angle-double-right"> </i></a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    var googleMapDivId = 'map';
    require(['jquery', 'MGS_StoreLocator/js/storelocator'], function($) {
        $(window).on('load', function() {
            <?php if ($this->getRequest()->getParam('lat_search') && $this->getRequest()->getParam('long_search')) : ?>
                google.maps.event.addDomListener(window, 'load', drawMapWithCircle(markers, googleMapDivId, <?php echo $this->getRequest()->getParam('lat_search') ?>, <?php echo $this->getRequest()->getParam('long_search') ?>, <?php echo $this->getRequest()->getParam('radius') ?>));
            <?php else : ?>
                google.maps.event.addDomListener(window, 'load', drawMap(markers, googleMapDivId, false, false));
            <?php endif ?>

            $('#search_radius').click(function() {
                var $form = $('#search_by_distance');
                if ($form.valid()) {
                    $.ajax({
                        type: "GET",
                        dataType: "json",
                        url: "http://maps.googleapis.com/maps/api/geocode/json",
                        data: {
                            'address': $('#location').val(),
                            'sensor': false
                        },
                        success: function(data) {
                            if (data.results.length) {
                                latitude = data.results[0].geometry.location.lat;
                                longitude = data.results[0].geometry.location.lng;
                                $('#lat_search').val(latitude);
                                $('#long_search').val(longitude);

                                $("#search_by_distance").submit();
                            }
                        }
                    });
                }
            });
        });

    });
</script>
